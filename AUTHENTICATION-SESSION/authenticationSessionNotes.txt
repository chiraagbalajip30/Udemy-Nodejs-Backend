## Video - 58

Adding Session-Based Authentication using Drizzle-ORM

SO, i have created a folder clled AUTHENTICATION-SESSION.

Now we will be using PNPM as our package manager isntead of npm. It is same as npm, but it's a better version of npm. It is more fast, optimal and it caches.
PNPM - Performant Node Package Manager.

Installation:
https://pnpm.io/installation

Taught in course:
Step 1 - pnpm init
Step 2 - pnpm @types/node @types/express@4.x -D
Step 3 - pnpm i express@4.x
Step 4 - Create an index.js file

So, now we need to create end-end authentication system. That means we need a dtabase as well.

const express = require("express");
This can be also imported as:
import express from 'express';

const PORT = process.env.PORT ?? 8000; - fallback option or value for port.

Wirte basic imports and listening of ports in index file.

After that, I have done some modifications in the package.json dependencies:
"type": "module",
"scripts": {
"start": "node index",
"dev": "node --watch index"
},

Now, we have to start by adding a Database. So, we will now use Drizzle ORM.

https://orm.drizzle.team/docs/get-started/postgresql-new

## Step - 0

Open the above link
In this,
create db folder
Within db folder, create schema.js and index.js files. We will see if index.js is required within db folder. If not required, we will remove it later.

## Step-1

Install:
select pnpm, and pnpm add drizzle-orm pg dotenv
then, pnpm add -D drizzle-kit tsx @types/pg

## Step-2

Create .env file, and place the url inside it by following the order as thought in earlier classes.


Step-3
--------
Step 3 - Connect Drizzle ORM to the database
Create a index.ts file in the src directory and initialize the connection:

import 'dotenv/config';
import { drizzle } from 'drizzle-orm/node-postgres';
const db = drizzle(process.env.DATABASE_URL);

also, export this at the end like:

export default db;
or
export.modules = db;


Step-4 
-------
Setup Drizzle Config file

import 'dotenv/config';
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  out: './drizzle',
  schema: './src/db/schema.ts',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});



Step-5
------------
Create a schema.ts file in the src/db directory and declare your table:

import { integer, pgTable, varchar, text } from "drizzle-orm/pg-core";

export const usersTable = pgTable("users", {
  id: uuid().primaryKey().defaultRandom(),
  name: varchar({ length: 255 }).notNull(),
  email: varchar({ length: 255 }).notNull().unique(),
  password: text().notNull(),
  salt: text().notNull(),
});

password should not be as a plain text because someone can easily hack it. 
So, we must "Hash the Password".
Best way to do that is something known as "Salt Hashing". This means that for every user, we can generate some random strings. 
Combination of our password + random strings = password that will be stored. 
Then we need to store the hash in the db. 



Next Step is npx drizzle-kit push.

Step-6
-------
But before that, we need to setup a db uding docker. 
After opening the docker app, if you just want o confirm if it is running, tyepe  'docker ps'. Then you can see some commands like container id, image, ports, names, etc.

Now, let us create, a docker-compose.yml file. 

services:
  db:
    image: postgres
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: myPassword
      POSTGRES_DB: postgres
    ports:
      - 5432:5432
    volumes:
      - db_data:/var/lib/postgresql/data

volumes:
  db_data:

NOTE:
Container = Computer
Volume = Hard Drive

Then, type in terminal:  docker compose up -d 
Then to check if the docker is active, type:  docker ps

Step-2 Used now
----------------
DATABASE_URL=postgres://postgres:myPassword@localhost:5432/postgres

We will write the url in the same order:
container type-postgressql:;;username:password@localhost:portNumber/dbName


Step - 7
---------
now we must type in the terminal:  npx drizzle-kit push, and then:  npx deizzle-kit studio.

We can also declare the in package.json scripts, and call the shorte forms in the terminal. 

"db:push": "drizzle-kit push",
"db:studio": "drizzle-kit studio"

From the next time after declaring this, we just need to write pnpm db:push instead of npx drizzle-kit pus, and pnpm db:studio, instead of npx drizzle-kit studio. 












